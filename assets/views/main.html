<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Rushanshare</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="../css/main.css?v=2">
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
 <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
</head>
<body>	

	<section id="home" class="page active __container">
	</section>
	 <section id="mapsec" class="page __container">
		<div id="map">
	</section>
	<section id="add" class="page __container">
		<div class="upload-container">
			<form class="addPost-form" action="/addpost" method="post" enctype="multipart/form-data">
				<input name="caption" type="text" id="postCaption">
				<input name="imageFile" type="file" id="postFile">
				<button id="openCoordMap" type="button" class="coordMap-btn">Open Map</button>
				<input id="uploadCoordinates" type="hidden" name="coordinates">
				<input type="submit">
			</form>
			<div  class="selectCoords-container">
					
				<button id="closeCoordMap" type="button" class="coordMap-btn"><i class="fa-solid fa-x"></i></button>
				<div class="search-container">
					<div id="uploadSearch" class="uploadSearch-suggestions-container"></div>			
					<input type="search" placeholder="Region or Town" id="searchPlaces">
				</div>
					
				
				<div class="coordsMap" id="coordsMap"></div>
				<div id="uploadMap"></div>
			</div>
			
		</div>
	</section>
	<section id="profile" class="page __container">
		<div class="userInfo-container">
		</div>
	</section>
<nav id="bottom-nav">
  <button data-target="home" class="button active"><i class="fas fa-home"></i>Home</button>
  <button data-target="mapsec" class="button"><i class="fas fa-map"></i>Map</button>
  <button data-target="add" class="button"><i class="fas fa-plus-circle"></i>Add</button>
  <button data-target="profile" class="button"><i class="fas fa-user"></i>Profile</button>
</nav>

</body>

<script>










	const GBAO = [
  {
    "name": "Khorugh",
    "latitude": 37.4904,
    "longitude": 71.5534,
    "notes": "Capital of GBAO" 
  },
  {
    "name": "Ishkoshim",
    "latitude": 36.72722,
    "longitude": 71.61167,
    "notes": "Border town on the Panj River"
  },
  {
    "name": "Murghob",
    "latitude": 38.17023,
    "longitude": 73.96674,
    "notes": "Major town in eastern GBAO"
  },
  {
    "name": "Rushon",
    "latitude": 37.94487,
    "longitude": 71.55745,
    "notes": "Seat of Rushon District"
  },
  {
    "name": "Vanj",
    "latitude": 38.3705,
    "longitude": 71.4532,
    "notes": "Seat of Vanj District"
  },
  {
    "name": "Roshtqal'a",
    "latitude": 37.267,
    "longitude": 71.82,
    "notes": "Seat of Roshtqal'a District"
  },
  {
    "name": "Qal'ai Khumb",
    "latitude": 38.45413,
    "longitude": 70.78864,
    "notes": "Border town in Darvoz District"
  },
  {
    "name": "Alichur",
    "latitude": null,
    "longitude": null,
    "notes": "Village in Murghob District (coordinates not widely published)"
  }
]

	const suggestionCont = document.getElementById("uploadSearch")
	const searchTown = document.getElementById("searchPlaces")
	searchTown.addEventListener("input",(e)=>{
		suggestionCont.innerHTML=""
		for (let i = 0;i<GBAO.length;i++){
			if (GBAO[i].name.toLowerCase().includes(searchTown.value.toLowerCase())&&searchTown.value!==""){
				suggestionCont.insertAdjacentHTML("beforeend",`<div class="uploadSearch-suggestion" data-slug-coords="[${GBAO[i].latitude},${GBAO[i].longitude}]">
						<p>${GBAO[i].name}</p>
					</div>`)
			}
	const uploadSlugs = document.querySelectorAll(".uploadSearch-suggestion")
	uploadSlugs.forEach(slug=>{
		slug.addEventListener("click",()=>{
			suggestionCont.innerHTML=""
			console.log(slug.dataset.slugCoords[0])
			uploadMap.flyTo(JSON.parse(slug.dataset.slugCoords),12) })
	})
		}
	})



	const openMapBtn = document.getElementById("openCoordMap")
	const closeMapBtn = document.getElementById("closeCoordMap")
	const coordMap = document.querySelector(".selectCoords-container")

	openMapBtn.addEventListener("click",()=>{
                uploadMap.invalidateSize()
                coordMap.classList.toggle("selectCoords-container__active")
        })
	closeMapBtn.addEventListener("click",()=>{
                uploadMap.invalidateSize()
                coordMap.classList.toggle("selectCoords-container__active")
        })


	let coordinatesInput = document.getElementById("uploadCoordinates")

	const postsContainer = document.getElementById("home")
	const user = fetch("/api/user")
		.then(res=>res.json())
		.then(data=>{
			const profileContainer = document.querySelector(".userInfo-container")
			profileContainer.insertAdjacentHTML("beforeend",`
				<img class="userInfo-profilePic">
				<p class="userInfo-userName">${data.username}</p>
				<p class="userInfo-userNum">${data.phone}</p>
	
			`)	
		})
	async function getPosts(){
		const posts = await fetch("/api/feed")
		.then(res=>res.json())
		.then(data=>{
			console.log("niger",data)
			data.posts.forEach(post=>{
				postsContainer.insertAdjacentHTML("beforeend",`
		<div class="post-container">
			<h1 class="post-username">${post.userId}</h1>
			<div class="post-image-container">
				
				<img class="post-image" src="${post.imagePathname}">
			</div>
			<h1 class="post-caption">${post.caption}</h1>
			<div class="post-reactions-container">
				<button class="post-button-like">
					<i class="fa-regular fa-heart"></i>
				</button>
			</div>
		</div>`)
			})
		})
	const likebuttons = document.querySelectorAll(".post-button-like")
	likebuttons.forEach(btn=>{
		
		btn.addEventListener("click",(e)=>{
			const likeIcon = btn.querySelector("i")
				
			
			
			likeIcon.classList.toggle("fa-solid")
		})
	})
	}
	getPosts()


	const buttons = document.querySelectorAll("#bottom-nav button")
	const pages = document.querySelectorAll(".page")
	buttons.forEach(btn=>{
		btn.onclick = () =>{
			pages.forEach(page=>{
				page.classList.remove("active")
			})
			document.getElementById(btn.dataset.target).classList.add("active")
			if (btn.dataset.target==="mapsec"){
				map.invalidateSize()
			}
			buttons.forEach(b=>{
				b.classList.remove("active")
			})
			btn.classList.add("active")
		}
	})
	const colors = [
	  "#e41a1c",
	  "#377eb8",
	  "#4daf4a",
	  "#984ea3",
	  "#ff7f00",
	  "#ffff33",
	  "#a65628"
	];
	let currentColorIndex=-1
	function getColor(){	
		if(currentColorIndex>=colors.length-1){
			return {fillColor:'#000'}
		
		}
		console.log("color changed")
		currentColorIndex+=1
		return {fillColor:colors[currentColorIndex]}
		
	}
	var uploadMap = L.map("uploadMap").setView([37.9408, 71.5605],13)
	L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{
		maxZoom:19	
	}).addTo(uploadMap)

	var map = L.map('map').setView([37.9408, 71.5605],13)

	L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
	    maxZoom: 19
	}).addTo(map);
	fetch("../geojson/gbao.geojson")
	.then(res=>res.json())
	.then(data=>{
		L.geoJson(data, {style:(feature)=>{return getColor()}},{
  onEachFeature: (feature, layer) => {
    const name = feature.properties.shapeName;
    if (name) {
      const center = layer.getBounds().getCenter();
      L.marker(center, { 
        icon: L.divIcon({
          className: 'polygon-label',
          html: name,
          iconSize: null
        })
      }).addTo(map);
    }
  }
}).addTo(map);
	
	L.geoJson(data, {style:(feature)=>{return getColor()}}).addTo(uploadMap);


	})	
	var uploadGroup = L.layerGroup().addTo(uploadMap)
	uploadMap.on("click",(e)=>{
		uploadGroup.clearLayers()
		let lat = e.latlng.lat
		let lng = e.latlng.lng
		coordinatesInput.value = `[${[lat,lng]}]`
		L.marker([lat,lng]).addTo(uploadGroup)
	})
</script>

</html>

